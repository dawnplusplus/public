<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Final Firewall</title>
  <style>
    :root {
      --bg: #0b1321;
      --panel: #111a2b;
      --accent: #3ea6ff;
      --text: #e7eefc;
      --sub: #a8b3c7;
      --error: #ff5c77;
      --ok: #4ade80;
      --border: #1f2a44;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1000px 600px at 50% -10%, #14203a 0%, var(--bg) 60%);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap { min-height: 100%; display: grid; place-items: center; padding: 24px; }
    .card {
      width: min(960px, 92vw);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)), var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.04);
      position: relative;
      overflow: hidden;
    }
    .glow {
      position: absolute; inset: -40% -10% auto auto; width: 420px; height: 420px;
      background: radial-gradient(closest-side, rgba(62,166,255,0.18), rgba(62,166,255,0) 70%);
      filter: blur(8px); pointer-events: none;
    }
    header { display: grid; grid-template-columns: 120px 1fr; gap: 20px; align-items: center; margin-bottom: 18px; }
    .title { margin: 0; line-height: 1.2; font-size: clamp(20px, 3.5vw, 30px); letter-spacing: .04em; }
    .subtitle { margin: 6px 0 0; color: var(--sub); font-size: clamp(13px, 2.5vw, 16px); }
    .panel { margin-top: 18px; display: grid; gap: 12px; }
    label { font-weight: 600; color: var(--sub); letter-spacing: .06em; text-transform: uppercase; font-size: 12px; }
    input[type="email"], textarea {
      width: 100%;
      background: #0b1222; color: var(--text);
      border: 1px solid var(--border); border-radius: 10px;
      padding: 12px 14px; line-height: 1.4; font-size: 14px;
      outline: none; box-shadow: inset 0 1px 0 rgba(255,255,255,0.03);
    }
    textarea { min-height: 120px; resize: vertical; }
    input[type="email"]:focus, textarea:focus {
      border-color: var(--accent); box-shadow: 0 0 0 3px rgba(62,166,255,0.18);
    }
    .row { display: grid; grid-template-columns: 1fr 240px; gap: 12px; }
    .actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 4px; }
    button {
      background: linear-gradient(180deg, #2a79ff, #2563eb);
      color: white; border: none; border-radius: 10px; padding: 12px 16px;
      font-weight: 700; letter-spacing: .06em; text-transform: uppercase;
      cursor: pointer; transition: transform .06s ease, filter .2s ease, box-shadow .15s ease;
      box-shadow: 0 10px 20px rgba(37,99,235,.35), inset 0 1px 0 rgba(255,255,255,.15);
    }
    button:hover { filter: brightness(1.05); }
    button:active { transform: translateY(1px); }
    .status {
      margin-left: auto; font-weight: 700; letter-spacing: .06em; text-transform: uppercase;
      padding: 10px 12px; border-radius: 10px; min-width: 190px; text-align: center; border: 1px solid var(--border);
      background: #0b1222; color: var(--sub);
    }
    .status.ok { color: var(--ok); border-color: rgba(74,222,128,.45); box-shadow: 0 0 0 3px rgba(74,222,128,.15); }
    .status.err { color: var(--error); border-color: rgba(255,92,119,.4); box-shadow: 0 0 0 3px rgba(255,92,119,.12); }
    .hint { margin-top: 8px; color: var(--sub); font-size: 12px; }
    .footer { margin-top: 18px; color: var(--sub); font-size: 12px; text-align: center; }
    .codeBox {
      margin-top: 14px; padding: 12px 14px; border-radius: 10px; background: #0b1222; border: 1px solid var(--border);
      display: none;
    }
    .codeLabel { font-size: 12px; color: var(--sub); margin-bottom: 6px; text-transform: uppercase; letter-spacing: .06em; }
    .codeValue { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 16px; color: #eafff0; word-break: break-all; }
    .copyBtn { margin-left: 8px; background: #18c29c; color: #052018; border: none; padding: 6px 10px; border-radius: 8px; font-weight: 700; cursor: pointer; }
    .token {
      display: grid; gap: 6px; align-content: start; padding: 10px 12px;
      background: #0b1222; border: 1px solid var(--border); border-radius: 10px;
    }
    .tokenLabel { font-size: 12px; color: var(--sub); text-transform: uppercase; letter-spacing: .06em; }
    .tokenValue { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 16px; color: #bfe6ff; }
    @media (max-width: 640px) {
      header { grid-template-columns: 1fr; text-align: center; }
      .row { grid-template-columns: 1fr; }
      .status { margin-left: 0; width: 100%; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="region" aria-labelledby="ff-title">
      <div class="glow" aria-hidden="true"></div>

      <header>
        <!-- Inline SVG Vault -->
        <svg width="120" height="120" viewBox="0 0 160 160" role="img" aria-label="Vault door" xmlns="http://www.w3.org/2000/svg">
          <defs>
            <radialGradient id="g" cx="50%" cy="40%" r="70%">
              <stop offset="0%" stop-color="#89b8ff"/>
              <stop offset="50%" stop-color="#5a7fb8"/>
              <stop offset="100%" stop-color="#2b416b"/>
            </radialGradient>
          </defs>
          <!-- Vault body -->
          <circle cx="80" cy="80" r="72" fill="url(#g)" stroke="#263656" stroke-width="6"/>
          <!-- Hinges -->
          <rect x="130" y="52" width="14" height="16" rx="3" fill="#2d3f66"/>
          <rect x="130" y="92" width="14" height="16" rx="3" fill="#2d3f66"/>
          <!-- Dial ring -->
          <circle cx="80" cy="80" r="38" fill="#091322" stroke="#5e7fb0" stroke-width="3"/>
          <!-- Tick marks -->
          <g stroke="#99b7ee" stroke-width="2">
            <line x1="80" y1="44" x2="80" y2="50"/>
            <line x1="80" y1="110" x2="80" y2="104"/>
            <line x1="44" y1="80" x2="50" y2="80"/>
            <line x1="110" y1="80" x2="104" y2="80"/>
          </g>
          <!-- Dial center -->
          <circle cx="80" cy="80" r="10" fill="#cfe2ff" stroke="#38548a" stroke-width="3"/>
          <!-- Handle -->
          <g stroke="#b9d2ff" stroke-linecap="round" stroke-width="6">
            <line x1="80" y1="60" x2="80" y2="40"/>
            <line x1="60" y1="80" x2="40" y2="80"/>
            <line x1="100" y1="80" x2="120" y2="80"/>
            <line x1="80" y1="100" x2="80" y2="120"/>
          </g>
        </svg>

        <div>
          <h1 id="ff-title" class="title">FINAL FIREWALL ENGAGED.</h1>
          <p class="subtitle">ACCESS REQUIRES MASTER OVERRIDE PHRASE.</p>
        </div>
      </header>

      <form id="ff-form" class="panel" autocomplete="off">
        <div class="row">
          <div>
            <label for="email">Your school email (used to generate a unique success code):</label>
            <input id="email" name="email" type="email" placeholder="student@school.org" />
            <div class="hint">We derive a one-time code from your email + session token. Include both when you email your instructor.</div>
          </div>

          <div class="token">
            <div class="tokenLabel">Session Token (copy into your email):</div>
            <div id="sessionToken" class="tokenValue">—</div>
          </div>
        </div>

        <div>
          <label for="phrase">Enter phrase (ALL CAPS, hyphen‑separated):</label>
          <textarea id="phrase" name="phrase" spellcheck="false" placeholder="TYPE PHRASE HERE..."></textarea>
          <div class="hint">Tip: Use EXACT spacing and punctuation. Hyphens must be the plain '-' character.</div>
        </div>

        <div class="actions">
          <button id="btn-check" type="submit">Verify Phrase</button>
          <output id="status" class="status" role="status" aria-live="polite">Awaiting input…</output>
        </div>
      </form>

      <div id="codeBox" class="codeBox" aria-live="polite">
        <div class="codeLabel">Success code — email this to your instructor with your email and the Session Token:</div>
        <div class="codeValue"><span id="successCode">—</span>
          <button id="copyBtn" class="copyBtn" type="button">Copy</button>
        </div>
        <div class="hint">Format suggestion: “My Email: <em>me@school.org</em> • Session Token: <em>ABC123</em> • Success Code: <em>WXYZ-1234-ABCD</em>”.</div>
      </div>

      <div class="footer" aria-hidden="true">Security Monitor v10 • Event ID: FF-2026-01</div>
      <noscript>
        <div class="hint" style="color:#ffb4c0">JavaScript is required to verify the phrase.</div>
      </noscript>
    </div>
  </div>

  <script>
    // ================================
    // Robust client-only validator with unique, verifiable codes
    // - Normalizes input (dash variants, whitespace).
    // - Uses Web Crypto if available; falls back to a tiny SHA-256.
    // - Success code = SHA256( correctPhraseHash + "|" + email + "|" + sessionToken ), then prettified.
    // - Instructor can re-derive the code offline to verify authenticity.
    // ================================

    // EXPECTED HASH (lowercase hex) for the correct master phrase.
    const EXPECTED_HASH_HEX = "3085345eb9127de3da8419e32b67a36c4b68a960d3c3f83272733e9952db54f6";

    // Generate a session token on page load (A-Z + digits, no ambiguous chars).
    function generateSessionToken(len = 6) {
      const alphabet = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      const arr = new Uint8Array(len);
      if (window.crypto && crypto.getRandomValues) crypto.getRandomValues(arr);
      let out = "";
      for (let i = 0; i < len; i++) {
        const v = (arr[i] || Math.floor(Math.random()*256));
        out += alphabet[v % alphabet.length];
      }
      return out;
    }

    // Replace EN/EM dashes with '-', normalize quotes, collapse spaces, trim.
    function normalizeInput(s) {
      if (!s) return "";
      return s
        .replace(/\u2013|\u2014/g, "-")
        .replace(/[\u2018\u2019]/g, "'")
        .replace(/[\u201C\u201D]/g, '"')
        .replace(/\s*-\s*/g, "-")
        .replace(/ {2,}/g, " ")
        .trim();
    }

    async function sha256HexWebCrypto(input) {
      const data = new TextEncoder().encode(input);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return [...new Uint8Array(digest)].map(b => b.toString(16).padStart(2, "0")).join("");
    }

    // Tiny SHA-256 fallback (public domain style)
    function sha256HexFallback(ascii) {
      function rightRotate(value, amount) { return (value>>>amount) | (value<<(32 - amount)); }
      var mathPow = Math.pow, maxWord = mathPow(2, 32), lengthProperty = 'length';
      var i, j, result = '', words = [];
      var asciiBitLength = ascii[lengthProperty]*8;
      var hash = sha256HexFallback.h = sha256HexFallback.h || [];
      var k = sha256HexFallback.k = sha256HexFallback.k || [];
      var primeCounter = k[lengthProperty], isComposite = {};
      for (var candidate = 2; primeCounter < 64; candidate++) {
        if (!isComposite[candidate]) {
          for (i = 0; i < 313; i += candidate) isComposite[i] = candidate;
          hash[primeCounter] = (mathPow(candidate, .5)*maxWord)|0;
          k[primeCounter++] = (mathPow(candidate, 1/3)*maxWord)|0;
        }
      }
      ascii += '\x80';
      while (ascii[lengthProperty]%64 - 56) ascii += '\x00';
      for (i = 0; i < ascii[lengthProperty]; i++) {
        j = ascii.charCodeAt(i);
        if (j>>8) return; // ASCII check
        words[i>>2] |= j << ((3 - i)%4)*8;
      }
      words[words[lengthProperty]] = (asciiBitLength/maxWord)|0;
      words[words[lengthProperty]] = (asciiBitLength);
      for (j = 0; j < words[lengthProperty];) {
        var w = words.slice(j, j += 16), oldHash = hash;
        hash = hash.slice(0, 8);
        for (i = 0; i < 64; i++) {
          var w15 = w[i - 15], w2 = w[i - 2];
          var a = hash[0], e = hash[4];
          var temp1 = hash[7]
            + (rightRotate(e, 6) ^ rightRotate(e, 11) ^ rightRotate(e, 25))
            + ((e&hash[5])^((~e)&hash[6]))
            + k[i]
            + (w[i] = (i < 16) ? w[i] : (
                w[i - 16]
                + (rightRotate(w15, 7) ^ rightRotate(w15, 18) ^ (w15>>>3))
                + w[i - 7]
                + (rightRotate(w2, 17) ^ rightRotate(w2, 19) ^ (w2>>>10))
              )|0);
          var temp2 = (rightRotate(a, 2) ^ rightRotate(a, 13) ^ rightRotate(a, 22))
            + ((a&hash[1])^(a&hash[2])^(hash[1]&hash[2]));
          hash = [(temp1 + temp2)|0].concat(hash);
          hash[4] = (hash[4] + temp1)|0;
        }
        for (i = 0; i < 8; i++) hash[i] = (hash[i] + oldHash[i])|0;
      }
      for (i = 0; i < 8; i++) {
        for (j = 3; j + 1; j--) {
          var b = (hash[i] >> (j * 8)) & 255;
          result += ((b < 16) ? 0 : '') + b.toString(16);
        }
      }
      return result;
    }

    async function sha256Hex(input) {
      try {
        if (window.crypto && crypto.subtle && crypto.subtle.digest) {
          return await sha256HexWebCrypto(input);
        }
      } catch (_) { /* fall back */ }
      return sha256HexFallback(input);
    }

    // Make a human-friendly 12-char code (no O/0 or I/1), grouped 4-4-4
    function prettyCodeFromHex(hex, length = 12) {
      const map = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let out = "";
      for (let i = 0; i < hex.length && out.length < length; i += 2) {
        const byte = parseInt(hex.substr(i, 2), 16);
        out += map[byte % map.length];
      }
      const s = out.slice(0, length);
      return s.replace(/(.{4})(?=.)/g, "$1-");
    }

    async function deriveUniqueCode(phraseHashHex, emailLower, sessionToken) {
      // Deterministic payload the instructor can re-derive offline
      const payload = (phraseHashHex + "|" + (emailLower || "") + "|" + sessionToken).toUpperCase();
      const codeHash = await sha256Hex(payload);
      return prettyCodeFromHex(codeHash, 12);
    }

    // --- UI wiring ---
    const form = document.getElementById("ff-form");
    const emailEl = document.getElementById("email");
    const phraseEl = document.getElementById("phrase");
    const statusEl = document.getElementById("status");
    const codeBox = document.getElementById("codeBox");
    const successCodeEl = document.getElementById("successCode");
    const copyBtn = document.getElementById("copyBtn");
    const sessionTokenEl = document.getElementById("sessionToken");

    // Generate and show Session Token on load
    const SESSION_TOKEN = generateSessionToken(6);
    sessionTokenEl.textContent = SESSION_TOKEN;

    function setStatusOk(msg) {
      statusEl.textContent = msg;
      statusEl.classList.remove("err");
      statusEl.classList.add("ok");
    }
    function setStatusErr(msg) {
      statusEl.textContent = msg;
      statusEl.classList.remove("ok");
      statusEl.classList.add("err");
      codeBox.style.display = "none";
    }

    const params = new URLSearchParams(location.search);
    const debug = params.get("debug") === "1";

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      setStatusErr("Verifying…");

      try {
        const rawPhrase = (phraseEl.value || "");
        const candidate = normalizeInput(rawPhrase);

        if (!candidate) {
          setStatusErr("PHRASE REQUIRED");
          return;
        }

        const emailLower = (emailEl.value || "").trim().toLowerCase();
        if (!emailLower) {
          setStatusErr("EMAIL REQUIRED");
          return;
        }

        const candidateHash = await sha256Hex(candidate);

        if (debug) {
          console.log("[FF DEBUG] normalized phrase:", JSON.stringify(candidate));
          console.log("[FF DEBUG] candidate hash:", candidateHash);
          console.log("[FF DEBUG] expected   hash:", EXPECTED_HASH_HEX);
          console.log("[FF DEBUG] emailLower:", emailLower);
          console.log("[FF DEBUG] sessionToken:", SESSION_TOKEN);
        }

        if (candidateHash === EXPECTED_HASH_HEX) {
          setStatusOk("ACCESS GRANTED");
          const uniqueCode = await deriveUniqueCode(candidateHash, emailLower, SESSION_TOKEN);
          successCodeEl.textContent = uniqueCode;
          codeBox.style.display = "block";
        } else {
          setStatusErr("PHRASE INCORRECT");
        }
      } catch (err) {
        console.error(err);
        setStatusErr("SYSTEM ERROR");
      }
    });

    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(successCodeEl.textContent.trim());
        copyBtn.textContent = "Copied!";
        setTimeout(() => (copyBtn.textContent = "Copy"), 1200);
      } catch {
        // ignore clipboard errors
      }
    });
  </script>
</body>
</html>

